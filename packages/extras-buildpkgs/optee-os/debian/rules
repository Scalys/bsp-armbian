#!/usr/bin/make -f

include /usr/share/dpkg/architecture.mk
include /usr/share/dpkg/pkg-info.mk

# export CROSS_COMPILE ?= $(DEB_HOST_GNU_TYPE)-

# export MACHINE = "trustbox"

# export PLATFORM=ls-ls1012grapeboard

export CROSS_COMPILE64 = ${CROSS_COMPILE}

%:
	dh $@

override_dh_auto_configure:
	sed -i 's/from Crypto\./from Cryptodome\./g' scripts/*.py

override_dh_auto_build:
	$(MAKE) PLATFORM=ls-${OPTEE_PLATFORM} CFG_ARM64_core=y CFG_TA_RPC=y CFG_SCTLR_ALIGNMENT_CHECK=n ARCH=arm LDFLAGS= CFLAGS= 
	${CROSS_COMPILE}objcopy -v -O binary out/arm-plat-ls/core/tee.elf out/arm-plat-ls/core/tee_${OPTEE_PLATFORM}.bin

override_dh_strip:
	true

override_dh_fixperms:
	dh_fixperms --exclude usr/include/optee/export-user_ta/scripts/*
