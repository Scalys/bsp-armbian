#!/usr/bin/make -f

CROSS_COMPILE ?= ""
export CROSS_COMPILE

MACHINE ?= "trustbox"
export MACHINE

DEB_DESTDIR = debian/optee-os

%:
	dh $@

override_dh_auto_configure:
	sed -i 's/from Crypto\./from Cryptodome\./g' scripts/*.py

override_dh_auto_build:
	$(MAKE) PLATFORM=ls-ls1012grapeboard CFG_ARM64_core=y ARCH=arm CFG_WERROR=n LDFLAGS= CFLAGS=-Wno-error=implicit-function-declaration CFG_TEE_TA_LOG_LEVEL=0 
	objcopy -v -O binary out/arm-plat-ls/core/tee.elf out/arm-plat-ls/core/tee_${MACHINE}.bin

override_dh_auto_install:
	install -d ${DEB_DESTDIR}/lib/firmware/
	install -m 644 out/arm-plat-ls/core/tee.bin ${DEB_DESTDIR}/lib/firmware/tee_${MACHINE}.bin

	install -d ${DEB_DESTDIR}/usr/include/optee/export-user_ta/
	for f in out/arm-plat-ls/export-ta_arm64/* ; do \
		cp -aR $$f ${DEB_DESTDIR}/usr/include/optee/export-user_ta/ ; \
	done

	install -d ${DEB_DESTDIR}/lib/optee_armtz
	cp out/arm-plat-ls/ta/*/*.ta $(DEB_DESTDIR)/lib/optee_armtz

